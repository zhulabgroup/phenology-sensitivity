---
title: "leaf_flower_pollen"
author: "Yi"
date: "2023-07-03"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(see)
library(purrr)
library(tibble)
library(lubridate)
library(patchwork)
# ln -s /nfs/turbo/seas-zhukai/phenology/phenology_leaf_flower_lag  data
```

# leaf flower start date realtion in NPN 

## genus level correlation
First, we want to see in the 11 allergy causing genus, which has a high flower-leaf relationship therefore we can use leaf to infer flower.

```{r rlm, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_rlm_combined_8genuses.R") # after libaray mass, dplyr::select is masked
```

```{r rlm, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
combined_plot
```

Fig.1 Leaf and flowering day relationship of pollen allergy related genus. Each dot represents a individual in a year. Each color represent a species. The wide black line represents the total dots robust linear regression. The thin black line is the 1:1 line.

From this figure, we can see:
1. the data availability, Acer (species: ) and Quercus have the most observations
2. except grass, most of those species has a nearby leaf flower time and there is a clear correlation between leaf and flower. Grass has flower much later than leaf and the correlation between leaf and flower is messy.
3. Though with an overall clear genus level leaf-flower correlation. There is clear inter-species difference, e.g., maple can be flower first/leaf first (figure 2a), pine and oak (figure 2b) has some species always flower/leaf earlier while others always late which may undermine the genus level trend. There is a need for species level analysis

## species level correlation
```{r rlm, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
species_stat
# write_csv(species_stat, "data/figure1_stat.csv")
rm(list = ls())
```

```{r rlm, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_species_observation_slope.R") 
observation_slope
rm(list = ls())
```

Figure S1: relationship between number of observations and the leaf-flower linear model slope


Most species has positive relationship between leaf and flower. From this table and figure, we can see as we have more observations (more robust result), the slope is more between 0.5-1 (check those species). More close to 1 slope means leaf and flower has more sync change in both rate and direction. 


Let's disentangle the species in acer and oak

## oak species and acer species
```{r rlm, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_maple_oak_species.R") 
combined_plot
# rm(list = ls())
```

Figure 2: species level leaf-flower relationship. In each genus, species are arranged from most observation to least observation


From acer, we can see that red maple has a large window for both leafing and flowering while other species has a relative later and shorter window. Most of them leaf, no matter leaf first or flower first, has closely related leaf and flower time. Vine maple is a little special relative small flower variability than leaf may be related to (1) garden plants, human management (2) short shrub (refer to grass has flower-leaf not well related)

For oak, all the species have same leaf before flower order.  There is a clear different leaf/flower window for different species.

Together, most of them has a slope ~ 1 (leaf flower change at similar rate and direction). But most are smaller than 1 rather than larger than 1 which means leafing time change is greater than flowering change (variability). 

Let's see whether this reflects different sensibility of leaf and flower to environment change: if we consider warming tem and earlier events, leaf first (oak) will show an increasing lag, while flower first will show decrease lag (red maple). Since oaks are more consistent order, we use oak as an example to show environment change's effect.


# different sensitivity of flower and leaf to climate change

## download winter spring temperature
```{r}
# source("scripts/download_daymetwinsprtem_for_q.R")
```

## individual temporal change
```{r rlm, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_individual_oak_norm.R")
plot_individual_varibility
rm(list = ls())
```



## individual level spatial comparation
```{r}
source("scripts/plot_oak_spatial_compare.R")
rm(list = ls())
```

# using npn to predict pollen

## let's see the result if we supppose leaf and flower is the same and compare their ability to predict pollen
```{r station_lfp, message=FALSE, warning=FALSE, fig.width=8*1.618 , fig.height=8, cache=TRUE}
figures <- read_rds("/nfs/turbo/seas-zhukai/phenology/phenology_leaf_flower_lag/RMSE_Smooth_Quercus_leafflowerpollen.rds")
print(figures[24])
rm(list = ls())
```
Fig.3 Flowering and leafing initiation observations from npn and pollen count from nab.

We can see that: 1) we have more leafing observations than flowering. 2) leafing is a little bit ahead of flowering, adding a lag to leafing may make leaf fits better.

Here are the statistics:

```{r RMSE_sta, message=FALSE, warning=FALSE, fig.width=8*1.618 , fig.height=8,cache=TRUE} 
source("scripts/plot_RMSE_compare.R")
print(RMSE_violin)
rm(list = ls())
```

```{r}
rm(list = setdiff(ls(), c("npn_leaf", "npn_leaf_lag", "npn_flower", "nab")))
```

