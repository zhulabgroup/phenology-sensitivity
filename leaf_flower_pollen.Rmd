---
title: "leaf_flower_pollen"
author: "Yi"
date: "2023-07-03"
output: html_document
---

```{r setup, echo=FALSE, message=FALSE}
library(readr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(see)
library(purrr)
library(tibble)
library(lubridate)
library(patchwork)
# ln -s /nfs/turbo/seas-zhukai/phenology/phenology_leaf_flower_lag  data
```

# 1. leaf flower start date realtion in NPN 

## 1.1 genus level correlation
First, we want to see in the 11 allergy causing genus, which has a high flower-leaf relationship therefore we can use leaf to infer flower.

```{r fig1 prepare, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_rlm_combined_8genuses.R") # after libaray mass, dplyr::select is masked
```

```{r fig1, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
combined_plot
```

Fig.1 Leaf and flowering day relationship of pollen allergy related genus. Each dot represents a individual in a year. Each color represent a species. The wide black line represents the total dots robust linear regression. The thin black line is the 1:1 line.

From this figure, we can see:
1. the data availability, Acer (species: ) and Quercus have the most observations
2. except grass, most of those species has a nearby leaf flower time and there is a clear correlation between leaf and flower. Grass has flower much later than leaf and the correlation between leaf and flower is messy.
3. Though with an overall clear genus level leaf-flower correlation. There is clear inter-species difference, e.g., maple can be flower first/leaf first (figure 2a), pine and oak (figure 2b) has some species always flower/leaf earlier while others always late which may undermine the genus level trend. There is a need for species level analysis

## 1.2 species level correlation
```{r table1, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
species_stat
# write_csv(species_stat, "data/figure1_stat.csv")
rm(list = ls())
```

```{r sf1, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_species_observation_slope.R") 
observation_slope
rm(list = ls())
```

Figure S1: relationship between number of observations and the leaf-flower linear model slope


Most species has positive relationship between leaf and flower. From this table and figure, we can see as we have more observations (more robust result), the slope is more between 0.5-1 (check those species). More close to 1 slope means leaf and flower has more sync change in both rate and direction. 


Let's disentangle the species in acer and oak

## 1.3 oak species and acer species
```{r figure2, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_maple_oak_species.R") 
combined_plot
# rm(list = ls())
```

Figure 2: species level leaf-flower relationship. In each genus, species are arranged from most observation to least observation


From acer, we can see that red maple has a large window for both leafing and flowering while other species has a relative later and shorter window. Most of them leaf, no matter leaf first or flower first, has closely related leaf and flower time. Vine maple is a little special relative small flower variability than leaf may be related to (1) garden plants, human management (2) short shrub (refer to grass has flower-leaf not well related)

For oak, all the species have same leaf before flower order.  There is a clear different leaf/flower window for different species.

Together, most of them has a slope ~ 1 (leaf flower change at similar rate and direction). But most are smaller than 1 rather than larger than 1 which means leafing time change is greater than flowering change (variability). 

Let's see whether this reflects different sensibility of leaf and flower to environment change: if we consider warming tem and earlier events, leaf first (oak) will show an increasing lag, while flower first will show decrease lag (red maple). Since oaks are more consistent order, we use oak as an example to show environment change's effect.


# 2. different sensitivity of flower and leaf to climate change

## 2.1 download winter spring temperature
```{r}
# source("scripts/download_daymetwinsprtem_for_q.R")
```

## individual temporal change
```{r figure3:temporal, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_individual_oak_norm.R")
plot_individual_varibility
rm(list = ls())
```

Figure 3. Phenology's response to climate change reflected on inter-year climate varibility. Each dot is a individual-year. Each individual is recentered based on it's multiple-year average. So this figure shows the inter-year variblity of climate's impact on the same individual. We stack the individuals together to show a general trend. The red line is the linear model with intercept = 0 means no phenology change if no climate change (assumption).

From this figure we can see:
1. As tem increase (no matter winter or spring), leaf and flower will advance.
2. winter temperature has larger varibility than spring temperature. 
2. Both leaf and flower has a high sensitivity to spring tem change but less sensitivity to large winter tem change.
3. Leaf is more sensitive to winter temperature, so lag is bigger with increasing tem (leaf before flower). They have almost same sensitivity to spring tem so the lag's response to spring tem is tiny. 


## 2.2 individual spatial change
```{r figure4:spatial, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_oak_spatial_compare.R")
plot_spatial_varibility
rm(list = ls())
```

Figure 4. Phenology's response to climate change reflected on spatial distribution. Each dot is an indiviudal.

We can see that 
1. as moving to a warmer area, both leaf and flower will advance, but the trend is more dominant by species shift (sf2 to see intra-species trend)
2. as moving to warmer area, species composition is changing. therefore the spatial trend is not extendable because of the distribution limitation.
3. warmer area has a higher variability while phenology time at colder area is more constrained


```{r sf2, message=FALSE, warning=FALSE, fig.width=6*1.618 , fig.height=6, cache=TRUE}
source("scripts/plot_spatial_northredoak.R")
plot_spatial_northernredoak
rm(list = ls())
```

SF 2. Northern red oak's phenlogy response to climate reflected on spatial distribution. 

Interesting! Unlike one individual multiple year change, here we see that growing to in a warmer area has slight more impact on flower than leaf which cause a slight decrease in lag (leaf before flower). 


# 3. using npn to predict pollen

From those analysis we can see that leaf and flower mostly change synchronourly. The winter and spring temperature's impact on the lag between flower and leaf is tiny. Thus, using a fixed lag to use leaf to predict flower further pollen is plausible feasible. Here we use a sample study to show this.


similar super good: 2017	0.014835547	0.016191712	67e7f6ab-b262-45a0-b592-e71cbf433b2f
similar average good: 2016	0.031382947	0.039839431	6261714f-e5ae-41ef-96a7-0b1c108256a2
similar super bad: 2017	0.067786149	0.055293799	d22bab5b-768e-4bcc-a70f-8ebe9ef7cb4d

with leaf only, but leaf good: 2020	0.013496487	NA	fd742905-ee8d-4184-8543-23029fc676b1

```{r example_lfp, message=FALSE, warning=FALSE, fig.width=8*1.618 , fig.height=8, cache=TRUE}
source("scripts/plot_threeexamples_boxplotrmse.R")
three_examples_boxplot
```

Figure 5: Leaf has the same ability with flower in predict pollen. A. the good prediction flower and leaf make; moderate good prediction and bad prediction. B the RMSE summary of leaf and flower to predict pollen and the number of available compare pairs for flower and leaf.

From this figure we can see that flower and leaf has similar prediction accuracy of pollen. But we have more spatial coverage and more frequent observation for leaf which can increase polle prediction, specially for places without pollen observation.

