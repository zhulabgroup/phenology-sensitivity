---
title: 'complete npn data'
embed-resources: true
author: "Yi Liu"
date: "`r format(Sys.Date(), '%m/%d/%Y')`"
format:
  html:
    code-folding: show
    highlight: textmate
    number-sections: true
    theme: flatly
    toc: TRUE
    toc-depth: 4
    toc-float:
      collapsed: false
      smooth-scroll: true
---

```{r}
library(dplyr)
library(ggplot2)
library(readr)
library(patchwork)
library(ggtext)
```

# get npn data

## download npn

```{r eval = FALSE}
source("download_npn.R")
```

## quality control
```{r}
folder_path <- "/Volumes/seas-zhukai/phenology/NPN/individual_phenometrics/leaf_flower/with_climate/" 
#folder_path <- "E:/phenology/NPN/leaf_flower/climate/" 

# Get list of RDS files in the folder
rds_files <- list.files(path = folder_path, pattern = "\\.rds$", full.names = TRUE)

#rds_files delete these with name include "Ambrosia" or "Poaceae
rds_files <- rds_files[!grepl("Ambrosia", rds_files)]
rds_files <- rds_files[!grepl("Poaceae", rds_files)]

# Initialize an empty data frame to store the combined data
combined_data <- data.frame()

# Loop through each RDS file and combine the data
for (i in seq_along(rds_files)) {
  # Read the RDS file and append to the combined_data
  data <- read_rds(rds_files[i]) %>% 
    mutate(taxa = sub(".*\\/([^/]+)\\.rds$", "\\1", rds_files[i])) 
  combined_data <- rbind(combined_data, data)
}


```   
check how many observations deleted for each step

find a threshold for number of days since prior no to balance between number of data and quality of data

```{r eval = FALSE}
complete_npn_data %>% 
  filter(numdays_since_prior_no>0 & numdays_since_prior_no < 30) %>% 
  select(numdays_since_prior_no) %>%
  ggplot(aes(x = numdays_since_prior_no)) +
  geom_histogram()
```

```{r}
# Now, perform the filtering and processing steps on the combined data
complete_npn_data <- combined_data %>%
  filter(pheno_class_id == 7) %>% #22979
  # Remove rows with status conflicts
  filter(observed_status_conflict_flag == "-9999") %>% #20489
  # Group by individual_id, first_yes_year, and pheno_class_id
  group_by(individual_id, first_yes_year) %>%
  # Keep only the earlist first yes doy
  arrange(first_yes_doy) %>%
  slice(1) %>% # 16086
  ungroup() %>% 
  # Filter rows where numdays_since_prior_no is between 0 and 20
  filter(numdays_since_prior_no <= 7 & numdays_since_prior_no > 0) %>% # 8563
  # Select relevant columns
  dplyr::select(individual_id, first_yes_year, first_yes_doy, species, genus, dataset_id, pheno_class_id, longitude, latitude, taxa) 
```


## reshape doy to number of days since 11.1
```{r eval = FALSE}
flower_data <- complete_npn_data %>%
  rename(lat = latitude, lon = longitude, year = first_yes_year, doy = first_yes_doy) %>%
  mutate(species = paste(genus, species, sep = " ")) %>% 
  mutate(doy = doy + 61) %>%
  mutate(year = ifelse(doy > 365, year+1, year),
         doy = ifelse(doy > 365, doy - 365, doy)) 
```


# extract climate data
```{r eval = FALSE}
library(raster)

# extract the climate normality
complete_period_raster <- raster("../data/prism/complete_period_springmean.tif")

joint_data_flower_normality <- flower_data %>%
  dplyr::select(lat, lon) %>%
  distinct() %>%
  mutate(complete_period_temp = raster::extract(complete_period_raster, cbind(lon, lat)))

# extract the climate anormality
# Initialize an empty data frame to store the results
joint_data_flower_anormality <- data.frame()

# Loop through the specified years
for (fo_year in 2007:2023) {
  # Load the yearly raster file
  yearly_raster <- raster(paste0("../data/prism/", fo_year, "_springmean.tif"))
  
  # Process the joint_data_flower for the current year
  yearly_data <- flower_data %>%
    dplyr::select(year, lat, lon) %>%
    distinct() %>%
    filter(year == fo_year) %>%
    mutate(yearly_temp = raster::extract(yearly_raster, cbind(lon, lat)))
  
  # Append the yearly data to the cumulative data frame
  joint_data_flower_anormality <- rbind(joint_data_flower_anormality, yearly_data)
}

# Combine the normality and anormality data
temperature_data <- joint_data_flower_normality %>%
  right_join(joint_data_flower_anormality, by = c("lat", "lon")) %>%
  rename(norm = complete_period_temp, yeart = yearly_temp) %>%
  mutate(anom = yeart - norm) %>%
  right_join(flower_data, by = c("lat", "lon", "year")) %>%
  filter(!is.na(anom)) %>% #17587->17490
  group_by(species) %>%
  filter(n()>29) %>%   # 
  ungroup()

write.csv(temperature_data, "../data/npn_temperature_data.csv")
```

# fit the model
```{r}
temperature_data <- read.csv("../data/npn_temperature_data.csv")
```

## get data for model by requiring 10 observations for each parameter
```{r}
temperature_data_model <- temperature_data %>%
  group_by(species) %>%
  filter(n_distinct(anom) > 10) %>%  # Use n_distinct() for distinct counting
  filter(n_distinct(norm) > 10) %>%  # Use n_distinct() for distinct counting
  filter(n_distinct(doy, norm, anom) > 30) %>%  # Use n_distinct() for distinct counting
  ungroup() # 7601->6109

# by species colinearity
temperature_data_model %>%
  group_by(species) %>%
  summarise(cor_anom_norm = cor(anom, norm, use = "complete.obs")) %>% 
  arrange(desc(abs(cor_anom_norm)))

# by species unique value of doy, norm, anom and combination
# test <- temperature_data_model %>%
#   group_by(species) %>%
#   summarise(n_doy = n_distinct(doy),
#             n_norm = n_distinct(norm),
#             n_anom = n_distinct(anom),
#             n_comb = n_distinct(paste(doy, norm, anom))) %>%
#   arrange(desc(n_comb))

```
## plot and fit the model
```{r eval=FALSE}
source("../scripts/function_visionalize_summmary_MLmodel.R")

# Apply the function to each species and store the results
results <- list()
unique_species <- unique(temperature_data_model$species)

for (species_name in unique_species) {
  print(species_name)
  results[[species_name]] <- analyze_species(temperature_data_model, species_name)
}

# Combine all summary rows into a single data frame
summary_results <- bind_rows(lapply(results, function(res) res$summary))

# Save all plots to a single PDF file
pdf("../data/species_plots_npn.pdf", width = 8, height = 6)
for (species_name in unique_species) {
  print(results[[species_name]]$plot)
}
dev.off()

write.csv(summary_results, "../data/species_summary_npn.csv", row.names = FALSE)
```
```{r}
summary_results <- read.csv("../data/species_summary_npn.csv")
```

## get taxa
```{r}
summary_results_wtaxa <- temperature_data_model %>%
  distinct(species, taxa) %>% 
  right_join(summary_results, by = "species")  %>%  
  mutate(anom_large = (anom_estimate > norm_estimate)) %>%
  mutate(model_fit = case_when(
    residual <= 20 ~ "Good",
    residual <= 40 ~ "Moderate",
    TRUE ~ "Poor"
  )) %>% # variance of difference
  mutate(alpha_level = case_when(
    diff_var <= 5 ~ "Low",
    diff_var <= 10 ~ "Medium",
    TRUE ~ "High"
  ))
```
## summary figure

### marginal comparason

```{r fig.width=6, fig.height=6}
# Create the density plot
p_density <- ggplot(summary_results_wtaxa) +
  geom_density(aes(x = norm_estimate, fill = "Spatial"), alpha = 0.5, color = NA) +
  geom_density(aes(x = anom_estimate, fill = "Temporal"), alpha = 0.5, color = NA) +
  xlim(-30, 10) +
  labs(
    title = "",
    x = "",
    y = "",
    fill = "Sensitivity type"
  ) +
  scale_fill_manual(values = c("red", "purple")) +
  theme_minimal() +
  theme(axis.title.y = element_blank(), axis.text.y = element_blank(), axis.ticks.y = element_blank(),
        axis.title.x = element_blank(), axis.text.x = element_blank(), axis.ticks.x = element_blank(),
        panel.grid = element_blank())

# Combine the datasets for the scatter/errorbar plot
summary_results_wtaxa_combined <- summary_results_wtaxa %>%
  mutate(sensitivity_type = "Spatial", estimate_combined = norm_estimate, conf_low_combined = norm_conf_low, conf_high_combined = norm_conf_high) %>%
  bind_rows(
    summary_results_wtaxa %>%
      mutate(sensitivity_type = "Temporal", estimate_combined = anom_estimate, conf_low_combined = anom_conf_low, conf_high_combined = anom_conf_high)
  )



# Create the combined scatter/errorbar plot
p_combined <- summary_results_wtaxa_combined %>% 
    mutate(species_name = forcats::fct_reorder(species, desc(species))) %>%
ggplot(aes(x = estimate_combined, y = species_name, color = taxa, alpha = model_fit, shape = sensitivity_type)) +
  geom_point(size = 2, position = position_dodge(width = 0.5)) + # Adjust width as needed
  coord_cartesian(xlim = c(-30, 10)) +  # This will clip the error bars instead of removing them
  geom_errorbar(aes(xmin = conf_low_combined, xmax = conf_high_combined, alpha = model_fit), width = 0, position = position_dodge(width = 0.5)) +
  scale_alpha_manual(values = c("Good" = 1, "Moderate" = 0.5, "Poor" = 0.2), labels = c("Good", "Moderate", "Poor")) +
  scale_color_discrete(
    labels = function(x) {
      sapply(x, function(label) paste0("*", label, "*"))
    }
  ) +
  labs(
    title = "",
    x = "Sensitivity (days/°C)",
    y = "Species",
    color = "Taxa",
    shape = "Sensitivity type",
    alpha = "Model fit"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(face = "italic"),
    legend.text = element_markdown() # Italicize legend text
  )

# Stack the plots vertically using patchwork
combined_plot <- p_density / plot_spacer() / p_combined + plot_layout(heights = c(1, -2, 30))
print(combined_plot)
```

### joint comparason
```{r}
# Ensure alpha_level is a factor with the correct level order
summary_results_wtaxa$alpha_level <- factor(summary_results_wtaxa$alpha_level, levels = c("Low", "Medium", "High"))
# this is weird but happened a lot

ggplot(summary_results_wtaxa, aes(x = anom_estimate, y = norm_estimate, color = taxa, alpha = factor(alpha_level), shape = as.factor(equal + 3))) +
  geom_point(size = 3) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed", color = "gray") +
    scale_alpha_manual(values = c("Low" = 1, "Medium" = 0.5, "High" = 0.2), labels = c("Low", "Medium", "High")) +
  scale_shape_manual(values = c("3" = 16, "4" = 17), labels = c("3" = "Yes", "4" = "No 69% (22/32)")) +
  scale_color_discrete(
    labels = function(x) {
      sapply(x, function(label) paste0("*", label, "*"))
    }
  ) +
  labs(
    title = "",
    x = "Temporal sensitivity (days/°C)",
    y = "Spatial sensitivity (days/°C)",
    shape = "Significant difference",
    alpha = "Variance",
    color = "Taxa"
  ) +
  theme_minimal() +
  theme(legend.position = "right",
        legend.text = element_markdown()) # Italicize legend text
```

## summary statistics
```{r}
summary(summary_results_wtaxa)

sum(summary_results_wtaxa$equal)

summary_results_wtaxa %>% 
  group_by(taxa) %>%
  summarise(n = n(), n_equal = sum(equal), p = n_equal/n, n_larger = sum(anom_large), p_anom_large = n_larger/n) %>% 
  arrange(desc(p))
```



## data composition

```{r}
# summarize for each genus, species, indiviudal, how many data points, summarize in each level
data_summary_species <- temperature_data_model %>%
  group_by(taxa, species, individual_id) %>%
  summarise(n = n()) %>%
  group_by(taxa, species) %>%
  summarise(n = sum(n), n_individual = n_distinct(individual_id)) 

data_summary_genus <- temperature_data %>%
  group_by(taxa, individual_id) %>%
  summarise(n = n()) %>%
  group_by(taxa) %>%
  summarise(n = sum(n), n_individual = n_distinct(individual_id)) 

print(data_summary_species)
data_summary_genus
```



